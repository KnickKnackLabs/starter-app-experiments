# Internationalization (i18n)

This project uses [i18next](https://www.i18next.com/) with [react-i18next](https://react.i18next.com/) for internationalization across all platforms.

## Supported Languages

| Code | Language | Direction |
|------|----------|-----------|
| `en` | English | LTR |
| `es` | Spanish | LTR |
| `he` | Hebrew | RTL |
| `ar` | Arabic | RTL |
| `ru` | Russian | LTR |

## Architecture

```
packages/core/
  src/i18n/
    index.ts      # Exports: resources, supportedLanguages, isRtl, etc.
    resources.ts  # Combines all locale files
    types.ts      # TypeScript augmentation for i18next
  locales/
    en.ts         # English translations (source of truth)
    es.ts         # Spanish
    he.ts         # Hebrew (RTL)
    ar.ts         # Arabic (RTL)
    ru.ts         # Russian

apps/web/          # TanStack Start
  src/i18n.ts      # Web initialization + SSR cookie detection

apps/expo/         # Expo Router
  i18n.ts          # Native initialization + AsyncStorage persistence

apps/storybook/    # Web Storybook
  .storybook/
    i18n.ts        # Storybook i18n initialization
    preview.tsx    # I18nextProvider decorator + RTL support

apps/expo/.rnstorybook/
  preview.tsx      # Language picker + RTL support for native Storybook
```

## Adding a New Translation String

### 1. Add to English (source of truth)

Edit `packages/core/locales/en.ts`:

```typescript
export default {
  // ... existing keys
  myFeature: {
    title: "Welcome to My Feature",
    description: "This is a new feature",
    buttons: {
      submit: "Submit",
      cancel: "Cancel",
    },
  },
} as const;
```

### 2. Add to all other locales

Edit each file in `packages/core/locales/`:

```typescript
// es.ts
myFeature: {
  title: "Bienvenido a Mi Función",
  description: "Esta es una nueva función",
  buttons: {
    submit: "Enviar",
    cancel: "Cancelar",
  },
},

// he.ts
myFeature: {
  title: "ברוכים הבאים לתכונה שלי",
  description: "זוהי תכונה חדשה",
  buttons: {
    submit: "שלח",
    cancel: "ביטול",
  },
},

// ar.ts
myFeature: {
  title: "مرحبا بك في ميزتي",
  description: "هذه ميزة جديدة",
  buttons: {
    submit: "إرسال",
    cancel: "إلغاء",
  },
},

// ru.ts
myFeature: {
  title: "Добро пожаловать в мою функцию",
  description: "Это новая функция",
  buttons: {
    submit: "Отправить",
    cancel: "Отмена",
  },
},
```

### 3. Use in components

```tsx
import { useTranslation } from "react-i18next";

function MyComponent() {
  const { t } = useTranslation();

  return (
    <div>
      <h1>{t("myFeature.title")}</h1>
      <p>{t("myFeature.description")}</p>
      <button>{t("myFeature.buttons.submit")}</button>
    </div>
  );
}
```

## TypeScript Support

Translations are fully typed. You get autocomplete for translation keys:

```tsx
t("myFeature.title")      // ✅ Valid
t("myFeature.tytle")      // ❌ TypeScript error
```

This is enabled by the type augmentation in `packages/core/src/i18n/types.ts`.

## RTL Support

### Detecting RTL

```typescript
import { isRtl } from "@starter/core/i18n";

const rtl = isRtl(i18n.language); // true for 'he' and 'ar'
```

### Web (TanStack Start)

RTL is handled automatically via the `dir` attribute on `<html>`:

```tsx
// apps/web/src/app.tsx
<html dir={isRtl(language) ? "rtl" : "ltr"} lang={language}>
```

### Native (Expo)

We use **pure JS conditional styling** instead of `I18nManager`:

```tsx
const rtl = isRtl(i18n.language);

<View className={`absolute top-12 ${rtl ? "left-4" : "right-4"}`}>
  <LanguagePicker />
</View>
```

**Why not `I18nManager.forceRTL()`?**

`I18nManager` methods require a full native restart to take effect, causing:
- Inconsistent state between JS and native
- Double-flipping when combined with conditional styles
- Different behavior on JS reload vs app restart

Pure JS conditional styling works immediately and consistently.

## Language Persistence

### Web

Language is stored in a cookie (`i18next`) and detected server-side for SSR:

```typescript
// Server: Read cookie in beforeLoad
const language = parseCookie(request.headers.get("cookie"))["i18next"];

// Client: i18next-browser-languagedetector handles storage
```

### Native

Language is stored in AsyncStorage:

```typescript
import AsyncStorage from "@react-native-async-storage/async-storage";

// Save
await AsyncStorage.setItem("user-language", language);

// Load on app start
const saved = await AsyncStorage.getItem("user-language");
```

## Storybook Integration

### Web Storybook

- Globe icon in toolbar to switch languages
- RTL applied to story content only (not Storybook UI)
- Stories use `useTranslation()` for translated text

```bash
pnpm web:storybook
```

### Native Storybook

- Language picker at top of each story
- Tap flag to expand, select language
- RTL applied via `direction` style

```bash
pnpm native:ios      # First time: build dev client
pnpm native:storybook
```

## Adding a New Language

1. Create locale file: `packages/core/locales/xx.ts`
2. Add to resources: `packages/core/src/i18n/resources.ts`
3. Add to `supportedLanguages` array
4. If RTL, add to `rtlLanguages` array
5. Update language pickers in:
   - `apps/web/src/components/language-picker.tsx`
   - `apps/expo/components/language-picker.tsx`
   - `apps/storybook/.storybook/preview.tsx`
   - `apps/expo/.rnstorybook/preview.tsx`

## Translation Guidelines

1. **Keep keys semantic**: Use `actions.save` not `buttons.saveButton`
2. **Nest by feature**: Group related strings under feature keys
3. **Use interpolation** for dynamic values: `"Welcome, {{name}}"`
4. **Avoid string concatenation**: Use full sentences for proper grammar
5. **Test RTL**: Always verify layouts with Hebrew/Arabic

## Common Patterns

### Interpolation

```typescript
// en.ts
home: {
  welcome: "Welcome to {{appName}}",
}

// Usage
t("home.welcome", { appName: t("common.appName") })
```

### Pluralization

```typescript
// en.ts
items: {
  count_one: "{{count}} item",
  count_other: "{{count}} items",
}

// Usage
t("items.count", { count: 5 }) // "5 items"
```

### Context

```typescript
// en.ts
friend: {
  male: "He is a friend",
  female: "She is a friend",
}

// Usage
t("friend", { context: "female" }) // "She is a friend"
```

## Troubleshooting

### Translations not updating

- Check that all locale files have the same structure
- Verify the key exists in all languages
- In Storybook, try switching away and back to the story

### RTL not working on native

- Don't use `I18nManager` - use conditional styling
- Ensure `isRtl()` is called with current language
- Check that the View has `direction` style applied

### TypeScript errors on translation keys

- Run `pnpm fix` to ensure locale files are properly formatted
- Verify key exists in `packages/core/locales/en.ts`
- Check for typos in nested key paths

---

# Localization Best Practices

Beyond translation, localization encompasses formatting, cultural considerations, and UI adaptation.

## Formatting with Intl API

i18next supports built-in formatters using the browser's `Intl` API. Use these for locale-aware formatting.

### Numbers

```typescript
// en.ts
stats: {
  users: "{{count, number}} users",
  percentage: "{{val, number(style: 'percent')}}",
}

// Usage
t("stats.users", { count: 1000 })      // "1,000 users" (en) / "1.000 users" (de)
t("stats.percentage", { val: 0.25 })   // "25%"
```

### Currency

```typescript
// en.ts
pricing: {
  amount: "{{val, currency(USD)}}",
  custom: "{{val, currency}}",  // Currency passed at runtime
}

// Usage
t("pricing.amount", { val: 99.99 })  // "$99.99"
t("pricing.custom", {
  val: 99.99,
  formatParams: { val: { currency: 'EUR' } }
})  // "€99.99"
```

### Dates and Times

```typescript
// en.ts
events: {
  date: "Event on {{val, datetime}}",
  relative: "{{val, relativetime}}",
}

// Usage
t("events.date", {
  val: new Date(),
  formatParams: {
    val: { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }
  }
})  // "Event on Thursday, December 19, 2024"

t("events.relative", { val: -3 })  // "3 days ago"
```

### Lists

```typescript
// en.ts
sharing: {
  sharedWith: "Shared with {{val, list}}",
}

// Usage
t("sharing.sharedWith", { val: ['Alice', 'Bob', 'Charlie'] })
// "Shared with Alice, Bob, and Charlie" (en)
// "Shared with Alice, Bob und Charlie" (de)
```

## Pluralization

Different languages have different plural rules. English has 2 forms, Arabic has 6, Chinese has 1.

### Cardinal Plurals

Use `_one`, `_other`, and additional suffixes as needed:

```typescript
// en.ts (2 forms: one, other)
notifications: {
  count_one: "{{count}} notification",
  count_other: "{{count}} notifications",
}

// ar.ts (6 forms: zero, one, two, few, many, other)
notifications: {
  count_zero: "لا إشعارات",
  count_one: "إشعار واحد",
  count_two: "إشعاران",
  count_few: "{{count}} إشعارات",
  count_many: "{{count}} إشعارًا",
  count_other: "{{count}} إشعار",
}

// Usage - i18next picks the right form automatically
t("notifications.count", { count: 0 })   // Uses appropriate form per language
t("notifications.count", { count: 1 })
t("notifications.count", { count: 5 })
```

### Ordinal Numbers

For "1st", "2nd", "3rd" etc:

```typescript
// en.ts
ranking: {
  place_ordinal_one: "{{count}}st place",
  place_ordinal_two: "{{count}}nd place",
  place_ordinal_few: "{{count}}rd place",
  place_ordinal_other: "{{count}}th place",
}

// Usage
t("ranking.place", { count: 1, ordinal: true })  // "1st place"
t("ranking.place", { count: 2, ordinal: true })  // "2nd place"
t("ranking.place", { count: 3, ordinal: true })  // "3rd place"
t("ranking.place", { count: 4, ordinal: true })  // "4th place"
```

### Zero as Special Case

Consider special messaging for zero:

```typescript
// en.ts
cart: {
  items_zero: "Your cart is empty",
  items_one: "{{count}} item in cart",
  items_other: "{{count}} items in cart",
}
```

## UI Design for Localization

### Text Expansion

Translations often expand significantly. German can be 35% longer than English.

**Do:**
- Design flexible layouts that accommodate expansion
- Use `flex-wrap`, `min-width` instead of fixed widths
- Test with longest translations (often German or Russian)

**Don't:**
- Use fixed-width containers for text
- Truncate without providing full text access (tooltip, etc.)

### Avoid String Concatenation

Word order varies by language. What works in English breaks elsewhere.

```typescript
// ❌ BAD - concatenation
const message = t("greeting") + " " + userName + "!";

// ❌ BAD - multiple keys assembled
const message = t("you.have") + " " + count + " " + t("messages");

// ✅ GOOD - single key with interpolation
t("greeting.user", { name: userName })
// en: "Hello, {{name}}!"
// de: "Hallo, {{name}}!"
// ja: "{{name}}さん、こんにちは！"
```

### Provide Context

Words can have multiple meanings. "Save" could mean "store data" or "rescue".

```typescript
// ❌ Ambiguous
actions: {
  save: "Save",
}

// ✅ Clear context through structure
document: {
  actions: {
    save: "Save",  // Clearly about saving a document
  },
},
emergency: {
  actions: {
    save: "Rescue",  // Different context
  },
}
```

### Images and Icons

- Avoid text in images (requires separate assets per language)
- Be aware of cultural differences (thumbs-up is offensive in some cultures)
- Mirror directional icons for RTL (arrows, progress indicators)

## RTL Layout Considerations

Beyond text direction, RTL affects the entire UI:

- Navigation typically moves to the right side
- Progress flows right-to-left
- Icons with directional meaning should be mirrored
- Some elements stay LTR (phone numbers, code, LTR brand names)

```tsx
// Example: Mirroring an arrow icon
const rtl = isRtl(i18n.language);

<ArrowIcon style={{ transform: rtl ? 'scaleX(-1)' : undefined }} />
```

## Development Workflow

When adding any user-facing text:

1. **Never hardcode strings** - Always use translation keys
2. **Add to all locales immediately** - Don't accumulate translation debt
3. **Use semantic keys** - `errors.networkFailed` not `error1`
4. **Group by feature** - Makes it easy to find and update
5. **Test in Storybook** - Switch languages to verify layouts
6. **Consider edge cases** - Empty states, errors, loading states

### Checklist for New Features

- [ ] All user-visible text uses `t()` function
- [ ] Keys added to all 5 locale files
- [ ] Pluralization used where counts are displayed
- [ ] Dates/numbers use Intl formatters
- [ ] Layout tested with German (long text) and Hebrew (RTL)
- [ ] Empty/zero states have appropriate messaging

## References

- [i18next Formatting](https://www.i18next.com/translation-function/formatting)
- [i18next Plurals](https://www.i18next.com/translation-function/plurals)
- [CLDR Plural Rules](https://unicode.org/cldr/charts/latest/supplemental/language_plural_rules.html)
- [Phrase Localization Best Practices](https://phrase.com/blog/posts/10-common-mistakes-in-software-localization/)
