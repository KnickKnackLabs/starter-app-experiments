#!/usr/bin/env bash
#MISE description="List Cloudflare API tokens"

set -eo pipefail

RESPONSE_FILE=$(mktemp)
trap 'rm -f "$RESPONSE_FILE"' EXIT

mise run -q cloudflare:api -- user/tokens > "$RESPONSE_FILE"

if [ "$(jq -r '.success' "$RESPONSE_FILE")" != "true" ]; then
  echo "Error: Failed to list tokens"
  jq -r '.errors[]?.message // empty' "$RESPONSE_FILE"
  exit 1
fi

COUNT=$(jq '.result | length' "$RESPONSE_FILE")

if [ "$COUNT" -eq 0 ]; then
  echo "No API tokens found."
  exit 0
fi

jq -r '.result[] | "  \(.name)\t\(.id)\t\(.status)\t\(.expires_on // "never")"' "$RESPONSE_FILE" \
  | sort \
  | column -t -s $'\t'
