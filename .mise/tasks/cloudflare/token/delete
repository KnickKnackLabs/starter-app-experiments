#!/usr/bin/env bash
#MISE description="Delete a Cloudflare API token"
#USAGE arg "<id>" help="Token ID to delete"

set -eo pipefail

TOKEN_ID="${usage_id:-$1}"

if [ -z "$TOKEN_ID" ]; then
  echo "Usage: mise run cloudflare:token:delete <token-id>"
  echo ""
  echo "Use 'mise run cloudflare:token:list' to find token IDs."
  exit 1
fi

RESPONSE_FILE=$(mktemp)
trap 'rm -f "$RESPONSE_FILE"' EXIT

mise run -q cloudflare:api -- "user/tokens/$TOKEN_ID" -X DELETE > "$RESPONSE_FILE"

if [ "$(jq -r '.success' "$RESPONSE_FILE")" != "true" ]; then
  echo "Error: Failed to delete token"
  jq -r '.errors[]?.message // empty' "$RESPONSE_FILE"
  exit 1
fi

echo "Token $TOKEN_ID deleted."
