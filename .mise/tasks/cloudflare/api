#!/usr/bin/env bash
#MISE description="Call the Cloudflare API (authenticated)"
#USAGE arg "<path>" help="API path (e.g. user/tokens/permission_groups)"
#USAGE flag "-X --method <method>" help="HTTP method (default: GET)"
#USAGE flag "-d --data <data>" help="Request body (JSON string or @file)"
#USAGE flag "--auth <auth>" help="Auth method: global-key, oauth (default: auto-detect)"

set -eo pipefail

PATH_ARG="${usage_path:-$1}"
METHOD="${usage_method:-GET}"
DATA="${usage_data:-}"
AUTH="${usage_auth:-}"

if [ -z "$PATH_ARG" ]; then
  echo "Usage: mise run cloudflare:api <path> [-X POST] [-d '{...}']" >&2
  echo "" >&2
  echo "Examples:" >&2
  echo "  mise run cloudflare:api user/tokens/permission_groups" >&2
  echo "  mise run cloudflare:api user/tokens -X POST -d '{...}'" >&2
  echo "  mise run cloudflare:api accounts" >&2
  exit 1
fi

# Strip leading slash or full URL prefix if provided
PATH_ARG="${PATH_ARG#/}"
PATH_ARG="${PATH_ARG#https://api.cloudflare.com/client/v4/}"

URL="https://api.cloudflare.com/client/v4/$PATH_ARG"

# Determine auth method
AUTH_HEADERS=()
if [ "$AUTH" = "global-key" ] || [ -z "$AUTH" ]; then
  # Try Global API Key from 1Password first
  API_KEY=$(op item get "Cloudflare Global API Key" --vault Agents --fields credential --reveal 2>/dev/null || true)
  EMAIL=$(op item get "Cloudflare Global API Key" --vault Agents --fields email 2>/dev/null || true)

  if [ -n "$API_KEY" ] && [ -n "$EMAIL" ]; then
    AUTH_HEADERS=(-H "X-Auth-Key: $API_KEY" -H "X-Auth-Email: $EMAIL")
  elif [ "$AUTH" = "global-key" ]; then
    echo "Error: Global API Key not found in 1Password" >&2
    exit 1
  fi
fi

if [ ${#AUTH_HEADERS[@]} -eq 0 ]; then
  # Fall back to OAuth token from wrangler
  TOKEN=$(wrangler auth token --json 2>/dev/null | jq -r '.token // empty')
  if [ -n "$TOKEN" ]; then
    AUTH_HEADERS=(-H "Authorization: Bearer $TOKEN")
  else
    echo "Error: No auth available. Run: mise run cloudflare:login" >&2
    exit 1
  fi
fi

# Build curl args
CURL_ARGS=(-s -X "$METHOD" "${AUTH_HEADERS[@]}")

if [ -n "$DATA" ]; then
  CURL_ARGS+=(-H "Content-Type: application/json")
  if [[ "$DATA" == @* ]]; then
    CURL_ARGS+=(--data "$DATA")
  else
    CURL_ARGS+=(--data "$DATA")
  fi
fi

# Make the request, write to temp file to avoid bash variable mangling on large responses
TMPFILE=$(mktemp)
trap 'rm -f "$TMPFILE"' EXIT

curl "${CURL_ARGS[@]}" "$URL" > "$TMPFILE"

# Output the response
cat "$TMPFILE"
