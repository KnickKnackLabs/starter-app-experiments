#!/usr/bin/env bash
#MISE description="Regenerate the experiments catalog on main"

set -eo pipefail

# Must be on main (or we switch to it)
CURRENT=$(git branch --show-current)
if [ "$CURRENT" != "main" ]; then
  echo "Switching to main to update catalog..."
  git stash --quiet 2>/dev/null || true
  git checkout main --quiet
  SWITCHED=true
fi

REPO_URL=$(git remote get-url origin | sed 's/\.git$//' | sed 's|git@github.com:|https://github.com/|')

# Collect all experiment branches and archived tags
BRANCHES=$(git branch -a --list 'experiment/*' 2>/dev/null | sed 's/^[* ]*//' | grep -v "^remotes/" || true)
REMOTE_BRANCHES=$(git branch -a --list 'remotes/origin/experiment/*' 2>/dev/null | sed 's|^.*/origin/||' || true)
ALL_BRANCHES=$(echo -e "$BRANCHES\n$REMOTE_BRANCHES" | sort -u | grep -v "^$" || true)
TAGS=$(git tag -l 'archived/*' 2>/dev/null || true)

# Project branches
PROJECT_BRANCHES=$(git branch -a --list 'project/*' 2>/dev/null | sed 's/^[* ]*//' | grep -v "^remotes/" || true)
REMOTE_PROJECTS=$(git branch -a --list 'remotes/origin/project/*' 2>/dev/null | sed 's|^.*/origin/||' || true)
ALL_PROJECTS=$(echo -e "$PROJECT_BRANCHES\n$REMOTE_PROJECTS" | sort -u | grep -v "^$" || true)

# Generate catalog
mkdir -p experiments

cat > experiments/README.md << 'HEADER'
# Experiments Catalog

> Auto-generated by `mise run experiment:catalog`. Do not edit manually.

## Experiments

| Name | Status | Based On | Date | Author | Description |
|------|--------|----------|------|--------|-------------|
HEADER

# Add experiment branches
while IFS= read -r branch; do
  [ -z "$branch" ] && continue
  NAME="${branch#experiment/}"
  MANIFEST=$(git show "$branch:experiment.json" 2>/dev/null || echo "{}")
  STATUS=$(echo "$MANIFEST" | jq -r '.status // "active"' 2>/dev/null || echo "active")
  DESC=$(echo "$MANIFEST" | jq -r '.description // ""' 2>/dev/null || echo "")
  BASE=$(echo "$MANIFEST" | jq -r '.baseBranch // ""' 2>/dev/null || echo "")
  CREATED=$(echo "$MANIFEST" | jq -r '.createdAt // "" | split("T")[0]' 2>/dev/null || echo "")
  AUTHOR=$(echo "$MANIFEST" | jq -r '.author // ""' 2>/dev/null || echo "")
  echo "| [$NAME]($REPO_URL/tree/$branch) | $STATUS | $BASE | $CREATED | $AUTHOR | $DESC |" >> experiments/README.md
done <<< "$ALL_BRANCHES"

# Add archived tags
while IFS= read -r tag; do
  [ -z "$tag" ] && continue
  NAME="${tag#archived/}"
  # Skip if already listed as a branch
  echo "$ALL_BRANCHES" | grep -q "experiment/$NAME" && continue
  MANIFEST=$(git show "$tag:experiment.json" 2>/dev/null || echo "{}")
  DESC=$(echo "$MANIFEST" | jq -r '.description // ""' 2>/dev/null || echo "")
  BASE=$(echo "$MANIFEST" | jq -r '.baseBranch // ""' 2>/dev/null || echo "")
  CREATED=$(echo "$MANIFEST" | jq -r '.createdAt // "" | split("T")[0]' 2>/dev/null || echo "")
  AUTHOR=$(echo "$MANIFEST" | jq -r '.author // ""' 2>/dev/null || echo "")
  echo "| [$NAME]($REPO_URL/tree/$tag) | archived | $BASE | $CREATED | $AUTHOR | $DESC |" >> experiments/README.md
done <<< "$TAGS"

# Add projects section if any exist
if [ -n "$ALL_PROJECTS" ]; then
  cat >> experiments/README.md << 'PROJECTS'

## Projects

Projects combine multiple experiments via merge.

| Name | Experiments | Date | Author |
|------|-------------|------|--------|
PROJECTS

  while IFS= read -r branch; do
    [ -z "$branch" ] && continue
    NAME="${branch#project/}"
    MANIFEST=$(git show "$branch:project.json" 2>/dev/null || echo "{}")
    EXPERIMENTS=$(echo "$MANIFEST" | jq -r '.experiments // [] | join(", ")' 2>/dev/null || echo "")
    CREATED=$(echo "$MANIFEST" | jq -r '.createdAt // "" | split("T")[0]' 2>/dev/null || echo "")
    AUTHOR=$(echo "$MANIFEST" | jq -r '.author // ""' 2>/dev/null || echo "")
    echo "| [$NAME]($REPO_URL/tree/$branch) | $EXPERIMENTS | $CREATED | $AUTHOR |" >> experiments/README.md
  done <<< "$ALL_PROJECTS"
fi

# Commit if changed
if [ -n "$(git diff --name-only experiments/README.md 2>/dev/null)" ] || [ -n "$(git status --porcelain experiments/README.md 2>/dev/null)" ]; then
  git add experiments/README.md
  git commit -m "catalog: update experiments index" --quiet
  echo "Catalog updated: experiments/README.md"
else
  echo "Catalog is already up to date."
fi

# Switch back if needed
if [ "${SWITCHED:-false}" = "true" ]; then
  git checkout "$CURRENT" --quiet
  git stash pop --quiet 2>/dev/null || true
fi
